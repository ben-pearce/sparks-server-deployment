name: code
services:
  code-server:
    image: lscr.io/linuxserver/code-server:4.100.2-ls273@sha256:511445e8877da1665b97d2ca39f03009a36edadba9959eefcc8ff3d1b0f42251
    container_name: code-server
    volumes:
      - ${CONFIG_DIR}/code:/config
      - workspaces:/workspaces
      - /var/lib/code-docker:/var/lib/docker
    secrets:
      - code_sudo_password
    environment:
      - PUID
      - PGID
      - TZ
      - DEFAULT_WORKSPACE=/workspaces
      - >
        DOCKER_MODS=linuxserver/mods:code-server-python3|
        linuxserver/mods:universal-docker-in-docker-28.1.1-2.36.2|
        linuxserver/mods:code-server-shellcheck|
        linuxserver/mods:code-server-nodejs
      - NODEJS_MOD_VERSION=20
      - MODS_DIND_PERSISTENCE=/var/lib/docker
      - FILE__SUDO_PASSWORD_HASH=/run/secrets/code_sudo_password
    restart: unless-stopped
    labels:
      readme.description: VS Code in the browser
      readme.links.github: https://github.com/coder/code-server
      traefik.enable: true
      traefik.http.routers.code-server.entrypoints: https
      traefik.http.routers.code-server.middlewares: authelia
      traefik.http.routers.code-server.rule: Host(`code.${HOST}`)
      traefik.http.routers.code-server.tls.certresolver: resolver
      traefik.http.services.code-server.loadbalancer.server.port: 8443
    hostname: sparks
    privileged: true
volumes:
  workspaces:
    driver_opts:
      type: 'nfs'
      o: 'addr=${NFS_HOST},nolock,soft,nfsvers=4'
      device: ':/mnt/fast/workspaces'
secrets:
  code_sudo_password:
    file: ../.secrets/code_sudo_password
